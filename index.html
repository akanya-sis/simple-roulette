<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ルーレットアプリ (localforage + ポインタ + モーダル)</title>
  <!-- localforageライブラリを読み込み (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    #app-container {
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      max-width: 1200px;
      margin: 0 auto;
    }
    #roulette-section {
      flex: 1;
      text-align: center;
      position: relative; /* ポインタを重ねるために必要 */
    }
    /* ルーレットキャンバス */
    #wheelCanvas {
      border: 1px solid #aaa;
      margin-bottom: 10px;
      max-width: 100%;
      display: block;
      margin: 0 auto;
    }
    /* 三角ポインタ */
    #pointer {
      position: absolute;
      left: 50%;
      top: 0;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 15px solid transparent;
      border-right: 15px solid transparent;
      border-bottom: 20px solid red;
      /* Canvasの上端あたりに置きたい場合は以下調整 */
      margin-top: 10px; 
      z-index: 10;
    }

    #spin-btn {
      font-size: 1.2rem;
      padding: 10px 20px;
      cursor: pointer;
      margin-top: 20px;
    }
    /* 設定・項目追加・履歴 */
    #settings-section {
      width: 350px;
      padding-left: 20px;
      box-sizing: border-box;
    }
    .box {
      margin-bottom: 20px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .box h2 {
      font-size: 1.2rem;
      margin: 0 0 10px;
    }
    #item-list, #history-list {
      padding: 0;
      margin: 0;
      list-style: none;
    }
    .item-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      align-items: center;
    }
    .item-row img {
      max-height: 40px;
      max-width: 80px;
      object-fit: contain;
      margin-right: 10px;
    }
    label { margin-right: 5px; }
    #debug-info {
      white-space: pre-wrap;
      background: #f9f9f9;
      padding: 10px;
      font-size: 0.9rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      display: none; /* デフォルト非表示 */
    }

    /* --- モーダル --- */
    #modal-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: none; /* 初期は非表示 */
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    #result-modal {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      width: 300px;
      text-align: center;
      position: relative;
    }
    #modal-close-btn {
      position: absolute;
      top: 5px;
      right: 10px;
      cursor: pointer;
      font-size: 1.2rem;
      border: none;
      background: transparent;
    }
    #modal-content img {
      max-width: 80px;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <h1>ルーレットアプリ</h1>

  <!-- モーダル (オーバーレイ + 内容) -->
  <div id="modal-overlay">
    <div id="result-modal">
      <button id="modal-close-btn">×</button>
      <div id="modal-content"></div>
    </div>
  </div>

  <div id="app-container">
    <!-- ルーレット表示セクション -->
    <div id="roulette-section">
      <!-- 三角ポインタ -->
      <div id="pointer"></div>
      <!-- キャンバス -->
      <canvas id="wheelCanvas" width="400" height="400"></canvas>
      <!-- スピンボタン -->
      <button id="spin-btn">スピン</button>
    </div>

    <!-- 設定・項目追加・履歴表示セクション -->
    <div id="settings-section">
      <!-- 項目追加ボックス -->
      <div class="box">
        <h2>項目追加</h2>
        <label for="textItem">テキスト</label>
        <input type="text" id="textItem" placeholder="例: りんご" />
        <button id="addTextBtn">追加</button><br><br>
        <label for="imageInput">画像</label>
        <input type="file" id="imageInput" accept="image/*" />
        <button id="addImageBtn">追加</button>
      </div>

      <!-- 項目一覧 -->
      <div class="box">
        <h2>現在の項目</h2>
        <ul id="item-list"></ul>
      </div>

      <!-- 当選履歴表示 -->
      <div class="box">
        <h2>当選履歴</h2>
        <ul id="history-list"></ul>
      </div>

      <!-- デバッグモード設定＆デバッグ情報 -->
      <div class="box">
        <h2>デバッグ設定</h2>
        <label for="debugToggle">デバッグモード</label>
        <input type="checkbox" id="debugToggle" />
        <div id="debug-info"></div>
      </div>
    </div>
  </div>

  <script>
    // localforageのインスタンスを設定 (キーPrefixなど任意)
    localforage.config({
      name: 'myRouletteApp'
    });

    // データを保存するキー名
    const ITEMS_KEY   = 'roulette_items';
    const HISTORY_KEY = 'roulette_history';
    const DEBUG_KEY   = 'roulette_debug';

    // グローバル変数
    let items       = []; // [{ type: 'text'|'image', value: string, imageObj?: Image, loaded?: bool }, ...]
    let historyData = []; // [{ time: string, type: 'text'|'image', value: string }, ...]
    let debugMode   = false;

    const canvas  = document.getElementById('wheelCanvas');
    const ctx     = canvas.getContext('2d');
    const spinBtn = document.getElementById('spin-btn');

    const itemListElem    = document.getElementById('item-list');
    const historyListElem = document.getElementById('history-list');
    const debugToggle     = document.getElementById('debugToggle');
    const debugInfoElem   = document.getElementById('debug-info');

    // モーダル
    const modalOverlay   = document.getElementById('modal-overlay');
    const modalCloseBtn  = document.getElementById('modal-close-btn');
    const modalContent   = document.getElementById('modal-content');

    let currentAngle  = 0; // ルーレットの現在角度
    let spinTimeout   = null;

    // --- ページロード時にデータを読み込み ---
    window.onload = () => {
      // localforageからまとめて読み込み (Promiseを使ってチェーンする例)
      localforage.getItem(ITEMS_KEY)
        .then(storedItems => {
          if (storedItems) items = storedItems;
          return localforage.getItem(HISTORY_KEY);
        })
        .then(storedHistory => {
          if (storedHistory) historyData = storedHistory;
          return localforage.getItem(DEBUG_KEY);
        })
        .then(storedDebug => {
          if (storedDebug) debugMode = storedDebug;
          // 画像タイプのitemsを再プリロード
          items.forEach(item => {
            if (item.type === 'image') {
              const img = new Image();
              img.src = item.value;
              item.imageObj = img;
              item.loaded   = false;
              img.onload = () => {
                item.loaded = true;
                renderWheel();
              };
            }
          });
        })
        .finally(() => {
          // 一通り読み込んだらUIを反映
          renderItemList();
          renderHistory();
          debugToggle.checked = debugMode;
          updateDebugInfo();
          renderWheel();
        });
    };

    // --- localforageへ保存 ---
    function saveItems() {
      // itemsを保存
      localforage.setItem(ITEMS_KEY, items).catch(err => {
        console.error('Failed to save items:', err);
      });
    }
    function saveHistory() {
      // 履歴が多くなりすぎないように最大20件に制限
      if (historyData.length > 20) {
        historyData = historyData.slice(0, 20);
      }
      localforage.setItem(HISTORY_KEY, historyData).catch(err => {
        console.error('Failed to save history:', err);
      });
    }
    function saveDebugFlag() {
      localforage.setItem(DEBUG_KEY, debugMode).catch(err => {
        console.error('Failed to save debug flag:', err);
      });
    }

    // --- ルーレット描画 ---
    function renderWheel() {
      const width   = canvas.width;
      const height  = canvas.height;
      const centerX = width / 2;
      const centerY = height / 2;

      ctx.clearRect(0, 0, width, height);

      if (items.length === 0) {
        ctx.font = '20px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('項目がありません', centerX, centerY);
        return;
      }

      // 1セクションの角度
      const sliceAngle = (2 * Math.PI) / items.length;

      // 各セクションを描画
      for (let i = 0; i < items.length; i++) {
        const startAngle = currentAngle + i * sliceAngle;
        const endAngle   = startAngle + sliceAngle;

        // セクション塗り
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, Math.min(width, height)/2 - 10, startAngle, endAngle);
        ctx.closePath();
        ctx.fillStyle = `hsl(${(360 / items.length) * i}, 70%, 70%)`;
        ctx.fill();

        // スライス中心角度
        const textAngle = startAngle + sliceAngle/2;

        // テキスト/画像を外周寄りに描画
        ctx.save();
        ctx.translate(centerX, centerY);
        ctx.rotate(textAngle);

        const radius = Math.min(width, height)/2 - 60; // テキスト/画像を配置する半径

        const item = items[i];
        if (item.type === 'text') {
          ctx.font      = '16px sans-serif';
          ctx.fillStyle = '#000';
          ctx.textAlign = 'left';
          ctx.fillText(item.value, radius, 0);
        } else if (item.type === 'image' && item.imageObj) {
          if (item.loaded) {
            const imgW = 60, imgH = 60;
            ctx.drawImage(item.imageObj, radius - imgW/2, -imgH/2, imgW, imgH);
          }
        }

        ctx.restore();
      }
    }

    // ポインタ（HTML/CSSで三角形を用意）のため、別途キャンバス上に描画はしない  
    // もしキャンバスに直接三角を描きたい場合はここで ctx の描画を行う

    // --- スピン開始 ---
    spinBtn.addEventListener('click', () => {
      if (items.length === 0) {
        alert('項目がありません。追加してください。');
        return;
      }
      startSpin();
    });

    function startSpin() {
      // 5~9周 + ランダム位置
      const totalSpins   = 5 + Math.floor(Math.random() * 5);
      const randomFactor = Math.random();
      const targetAngle  = 2 * Math.PI * totalSpins + 2 * Math.PI * randomFactor;

      let startTime = null;
      const duration = 3000; // 3秒アニメーション

      function animateSpin(timestamp) {
        if (!startTime) startTime = timestamp;
        const elapsed = timestamp - startTime;

        const progress = Math.min(elapsed / duration, 1);
        // ease-out
        const easeOut  = 1 - Math.pow((1 - progress), 3);

        currentAngle = easeOut * targetAngle;
        renderWheel();

        if (progress < 1) {
          spinTimeout = requestAnimationFrame(animateSpin);
        } else {
          cancelAnimationFrame(spinTimeout);
          spinTimeout = null;
          finishSpin(targetAngle);
        }
      }
      spinTimeout = requestAnimationFrame(animateSpin);
    }

    function finishSpin(finalAngle) {
      const sliceAngle    = (2 * Math.PI) / items.length;
      const normalized    = finalAngle % (2 * Math.PI);
      const index         = Math.floor(((2 * Math.PI - normalized + sliceAngle/2) % (2 * Math.PI)) / sliceAngle);
      const resultItem    = items[index];
      const timestamp     = new Date().toLocaleString();

      // 履歴に追加 (先頭に)
      historyData.unshift({
        time: timestamp,
        type: resultItem.type,
        value: resultItem.value
      });
      renderHistory();
      saveHistory();

      if (debugMode) {
        console.log('[DEBUG] 当選Index:', index, 'Item:', resultItem);
        updateDebugInfo();
      }

      // モーダルで当選結果を表示
      showResultModal(resultItem);
    }

    // --- モーダル ---
    function showResultModal(item) {
      // 中身をクリア
      modalContent.innerHTML = '';

      if (item.type === 'text') {
        const p = document.createElement('p');
        p.textContent = `当選: ${item.value}`;
        modalContent.appendChild(p);
      } else {
        const p = document.createElement('p');
        p.textContent = '当選（画像）';
        const img = document.createElement('img');
        img.src = item.value;
        modalContent.appendChild(p);
        modalContent.appendChild(img);
      }
      // モーダルを表示
      modalOverlay.style.display = 'flex';
    }
    modalCloseBtn.addEventListener('click', () => {
      modalOverlay.style.display = 'none';
    });

    // --- 項目追加(テキスト) ---
    const addTextBtn   = document.getElementById('addTextBtn');
    const textItemInput = document.getElementById('textItem');
    addTextBtn.addEventListener('click', () => {
      const textValue = textItemInput.value.trim();
      if (!textValue) return;

      items.push({ type: 'text', value: textValue });
      textItemInput.value = '';
      renderItemList();
      renderWheel();
      saveItems();
    });

    // --- 項目追加(画像) ---
    const addImageBtn = document.getElementById('addImageBtn');
    const imageInput  = document.getElementById('imageInput');
    addImageBtn.addEventListener('click', () => {
      if (imageInput.files && imageInput.files[0]) {
        const file   = imageInput.files[0];
        const reader = new FileReader();
        reader.onload = e => {
          // base64文字列を取得
          const base64Data = e.target.result;

          // 新しいItemを作り、画像オブジェクトを生成
          const img   = new Image();
          img.src     = base64Data;
          const newItem = { type: 'image', value: base64Data, imageObj: img, loaded: false };

          // 読み込み完了後フラグを立てて再描画
          img.onload = () => {
            newItem.loaded = true;
            renderWheel();
          };
          items.push(newItem);

          // UI更新
          renderItemList();
          saveItems();
        };
        reader.readAsDataURL(file);
        imageInput.value = ''; // リセット
      }
    });

    // --- 項目一覧を描画 ---
    function renderItemList() {
      itemListElem.innerHTML = '';
      items.forEach((item, index) => {
        const li = document.createElement('li');
        li.className = 'item-row';

        if (item.type === 'text') {
          li.textContent = item.value;
        } else {
          const img = document.createElement('img');
          img.src   = item.value;
          li.appendChild(img);
        }
        // 削除ボタン
        const delBtn = document.createElement('button');
        delBtn.textContent = '削除';
        delBtn.onclick = () => {
          items.splice(index, 1);
          renderItemList();
          renderWheel();
          saveItems();
        };
        li.appendChild(delBtn);

        itemListElem.appendChild(li);
      });
    }

    // --- 当選履歴を描画 ---
    function renderHistory() {
      historyListElem.innerHTML = '';
      historyData.forEach(h => {
        const li = document.createElement('li');
        const timeSpan = document.createElement('span');
        timeSpan.textContent = `[${h.time}] `;
        li.appendChild(timeSpan);

        if (h.type === 'text') {
          const textNode = document.createTextNode(h.value);
          li.appendChild(textNode);
        } else {
          const img = document.createElement('img');
          img.src = h.value;
          li.appendChild(img);
        }
        historyListElem.appendChild(li);
      });
    }

    // --- デバッグモード切り替え ---
    debugToggle.addEventListener('change', () => {
      debugMode = debugToggle.checked;
      updateDebugInfo();
      saveDebugFlag();
    });

    function updateDebugInfo() {
      if (!debugMode) {
        debugInfoElem.style.display = 'none';
        debugInfoElem.textContent   = '';
        return;
      }
      debugInfoElem.style.display = 'block';
      debugInfoElem.textContent =
        `items: ${JSON.stringify(items, null, 2)}\n\n` +
        `historyData: ${JSON.stringify(historyData, null, 2)}\n\n` +
        `currentAngle: ${currentAngle.toFixed(2)}`;
    }
  </script>
</body>
</html>
