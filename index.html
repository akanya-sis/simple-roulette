<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ルーレットアプリ（画像対策＆モーダル）</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    #app-container {
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      max-width: 1200px;
      margin: 0 auto;
    }
    /* 左側：ルーレット */
    #roulette-section {
      flex: 1;
      text-align: center;
    }
    #wheelCanvas {
      border: 1px solid #aaa;
      margin-bottom: 10px;
      max-width: 100%;
    }
    #spin-btn {
      font-size: 1.2rem;
      padding: 10px 20px;
      cursor: pointer;
    }
    /* 右側：項目追加・履歴・デバッグなど */
    #settings-section {
      width: 350px;
      padding-left: 20px;
      box-sizing: border-box;
    }
    .box {
      margin-bottom: 20px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .box h2 {
      font-size: 1.2rem;
      margin: 0 0 10px;
    }
    #item-list, #history-list {
      padding: 0;
      margin: 0;
      list-style: none;
    }
    .item-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      align-items: center;
    }
    .item-row img {
      max-height: 40px;
      max-width: 80px;
      object-fit: contain;
      margin-right: 10px;
    }
    label {
      margin-right: 5px;
    }
    #debug-info {
      white-space: pre-wrap;
      background: #f9f9f9;
      padding: 10px;
      font-size: 0.9rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      display: none; /* デフォルト非表示 */
    }

    /* --- モーダルウィンドウのスタイル --- */
    #modal-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: none; /* 初期は非表示 */
      justify-content: center;
      align-items: center;
    }
    #result-modal {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      width: 300px;
      text-align: center;
      position: relative;
    }
    #modal-close-btn {
      position: absolute;
      top: 5px;
      right: 10px;
      cursor: pointer;
      font-size: 1.2rem;
      border: none;
      background: transparent;
    }
    #modal-content img {
      max-width: 80px;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <h1>ルーレットアプリ</h1>

  <!-- モーダルオーバーレイ＆モーダル本体 -->
  <div id="modal-overlay">
    <div id="result-modal">
      <button id="modal-close-btn">×</button>
      <div id="modal-content">
        <!-- 結果を表示する要素 -->
      </div>
    </div>
  </div>

  <div id="app-container">
    <!-- ルーレット表示セクション -->
    <div id="roulette-section">
      <canvas id="wheelCanvas" width="400" height="400"></canvas><br/>
      <button id="spin-btn">スピン</button>
    </div>

    <!-- 設定・項目追加・履歴表示セクション -->
    <div id="settings-section">
      <!-- 項目追加ボックス -->
      <div class="box">
        <h2>項目追加</h2>
        <label for="textItem">テキスト</label>
        <input type="text" id="textItem" placeholder="例: りんご" />
        <button id="addTextBtn">追加</button><br><br>
        <label for="imageInput">画像</label>
        <input type="file" id="imageInput" accept="image/*" />
        <button id="addImageBtn">追加</button>
      </div>

      <!-- 項目一覧 -->
      <div class="box">
        <h2>現在の項目</h2>
        <ul id="item-list"></ul>
      </div>

      <!-- 当選履歴表示 -->
      <div class="box">
        <h2>当選履歴</h2>
        <ul id="history-list"></ul>
      </div>

      <!-- デバッグモード設定＆デバッグ情報 -->
      <div class="box">
        <h2>デバッグ設定</h2>
        <label for="debugToggle">デバッグモード</label>
        <input type="checkbox" id="debugToggle" />
        <div id="debug-info"></div>
      </div>
    </div>
  </div>

  <script>
    // --- グローバル変数 ---
    let items = [];         // [{ type: 'text'/'image', value: string, imageObj?: Image, loaded?: bool }, ...]
    let historyData = [];   // 当選履歴
    let debugMode = false;  // デバッグフラグ

    const canvas = document.getElementById('wheelCanvas');
    const ctx = canvas.getContext('2d');
    const spinBtn = document.getElementById('spin-btn');

    const itemListElem = document.getElementById('item-list');
    const historyListElem = document.getElementById('history-list');

    const debugToggle = document.getElementById('debugToggle');
    const debugInfoElem = document.getElementById('debug-info');

    // モーダル要素
    const modalOverlay = document.getElementById('modal-overlay');
    const modalCloseBtn = document.getElementById('modal-close-btn');
    const modalContent = document.getElementById('modal-content');

    let currentAngle = 0;   // 現在のルーレット角度
    let spinTimeout = null; // アニメーション制御ID

    // --- ページ読み込み時にLocalStorageから読み込み ---
    window.onload = () => {
      loadDataFromStorage();
      renderItemList();
      renderHistory();
      renderWheel();
      debugToggle.checked = debugMode;
      updateDebugInfo();
    };

    // --- LocalStorageへの保存/読み込み ---
    function saveDataToStorage() {
      localStorage.setItem('roulette_items', JSON.stringify(items));
      localStorage.setItem('roulette_history', JSON.stringify(historyData));
      localStorage.setItem('roulette_debug', JSON.stringify(debugMode));
    }
    function loadDataFromStorage() {
      const itemsData = localStorage.getItem('roulette_items');
      const historyDataStr = localStorage.getItem('roulette_history');
      const debugDataStr = localStorage.getItem('roulette_debug');
      if (itemsData) items = JSON.parse(itemsData);
      if (historyDataStr) historyData = JSON.parse(historyDataStr);
      if (debugDataStr) debugMode = JSON.parse(debugDataStr);

      // 読み込み直後に、画像タイプのものを再度preload（imageObjを生成）
      items.forEach(item => {
        if (item.type === 'image') {
          const img = new Image();
          img.src = item.value;      // base64読み込み
          item.imageObj = img;
          item.loaded = false;
          // 画像読み込み完了時にフラグを立てて再描画
          img.onload = () => {
            item.loaded = true;
            renderWheel();
          };
        }
      });
    }

    // --- ルーレット描画 ---
    function renderWheel() {
      const width = canvas.width;
      const height = canvas.height;
      const centerX = width / 2;
      const centerY = height / 2;

      // 1セクションの角度
      const sliceAngle = (2 * Math.PI) / (items.length || 1);

      // 背景クリア
      ctx.clearRect(0, 0, width, height);

      if (items.length === 0) {
        ctx.font = '20px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('項目がありません', centerX, centerY);
        return;
      }

      // セクションごとに描画
      for (let i = 0; i < items.length; i++) {
        const startAngle = currentAngle + i * sliceAngle;
        const endAngle = startAngle + sliceAngle;

        // セクションの色を決定（HSLを使った簡易的パターン）
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, Math.min(width, height)/2 - 10, startAngle, endAngle);
        ctx.closePath();
        ctx.fillStyle = `hsl(${(360 / items.length) * i}, 70%, 70%)`;
        ctx.fill();

        // テキストや画像の描画位置（セクションの中心角度）
        const textAngle = startAngle + sliceAngle / 2;

        // 描画開始状態を保存
        ctx.save();
        ctx.translate(centerX, centerY);
        ctx.rotate(textAngle);

        // 描画（テキスト/画像）の位置を外周寄りに設定
        const radius = Math.min(width, height) / 2 - 60; // 余白 60px

        if (items[i].type === 'text') {
          ctx.font = '16px sans-serif';
          ctx.fillStyle = '#000';
          // 文字の左端が (radius, 0) に来るように描く例
          ctx.textAlign = 'left';
          ctx.fillText(items[i].value, radius, 0);
        } else if (items[i].type === 'image' && items[i].imageObj) {
          const img = items[i].imageObj;
          // 画像が読み込まれていれば描画
          if (items[i].loaded) {
            // 画像の中心が (radius, 0) に来るように
            const imgW = 60; // 表示する画像サイズ(幅)
            const imgH = 60; // 表示する画像サイズ(高さ)
            ctx.drawImage(img, radius - (imgW / 2), - (imgH / 2), imgW, imgH);
          }
        }

        // 状態を元に戻す
        ctx.restore();
      }
    }

    // --- スピンボタン動作 ---
    spinBtn.addEventListener('click', () => {
      if (items.length === 0) {
        alert('項目がありません。追加してください。');
        return;
      }
      startSpin();
    });

    function startSpin() {
      // 5~9周 + ランダム位置
      const totalSpins = 5 + Math.floor(Math.random() * 5);
      const randomFactor = Math.random();
      const targetAngle = 2 * Math.PI * totalSpins + 2 * Math.PI * randomFactor;

      if (debugMode) {
        console.log('[DEBUG] randomFactor:', randomFactor);
        console.log('[DEBUG] totalSpins:', totalSpins);
        console.log('[DEBUG] targetAngle:', targetAngle);
      }

      let startTime = null;
      const duration = 3000; // アニメーション時間3秒

      function animateSpin(timestamp) {
        if (!startTime) startTime = timestamp;
        const elapsed = timestamp - startTime;

        const progress = Math.min(elapsed / duration, 1);
        // easeOut(キュービック)
        const easeOut = 1 - Math.pow(1 - progress, 3);

        currentAngle = easeOut * targetAngle;

        renderWheel();

        if (progress < 1) {
          spinTimeout = requestAnimationFrame(animateSpin);
        } else {
          cancelAnimationFrame(spinTimeout);
          spinTimeout = null;
          finishSpin(targetAngle);
        }
      }
      spinTimeout = requestAnimationFrame(animateSpin);
    }

    function finishSpin(finalAngle) {
      // 当選アイテムを割り出す
      const sliceAngle = (2 * Math.PI) / items.length;
      const normalizedAngle = finalAngle % (2 * Math.PI);
      // indexを計算するために、上向き(=0度)からの相対位置を使う
      const index = Math.floor(((2 * Math.PI - normalizedAngle + sliceAngle / 2) % (2 * Math.PI)) / sliceAngle);

      const resultItem = items[index];

      // 当選履歴に追加
      const timestamp = new Date().toLocaleString();
      historyData.unshift({
        time: timestamp,
        type: resultItem.type,
        value: resultItem.value
      });
      renderHistory();
      saveDataToStorage();

      if (debugMode) {
        console.log('[DEBUG] 当選インデックス:', index);
        console.log('[DEBUG] 当選項目:', resultItem);
        updateDebugInfo();
      }

      // モーダルで結果表示（alertの代わり）
      showResultModal(resultItem);
    }

    // --- モーダル操作 ---
    function showResultModal(item) {
      // 中身をクリア
      modalContent.innerHTML = '';

      // 当選項目に応じて表示
      if (item.type === 'text') {
        const p = document.createElement('p');
        p.textContent = `当選：${item.value}`;
        modalContent.appendChild(p);
      } else {
        // 画像の場合
        const img = document.createElement('img');
        img.src = item.value; // base64画像
        const p = document.createElement('p');
        p.textContent = '当選（画像）';
        modalContent.appendChild(p);
        modalContent.appendChild(img);
      }

      // モーダル表示
      modalOverlay.style.display = 'flex';
    }

    // モーダルを閉じる
    modalCloseBtn.addEventListener('click', () => {
      modalOverlay.style.display = 'none';
    });

    // --- テキスト項目追加 ---
    const addTextBtn = document.getElementById('addTextBtn');
    const textItemInput = document.getElementById('textItem');
    addTextBtn.addEventListener('click', () => {
      const textValue = textItemInput.value.trim();
      if (textValue) {
        items.push({ type: 'text', value: textValue });
        textItemInput.value = '';
        renderItemList();
        renderWheel();
        saveDataToStorage();
      }
    });

    // --- 画像項目追加 ---
    const addImageBtn = document.getElementById('addImageBtn');
    const imageInput = document.getElementById('imageInput');
    addImageBtn.addEventListener('click', () => {
      if (imageInput.files && imageInput.files[0]) {
        const file = imageInput.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
          // base64化した文字列を items に追加
          const img = new Image();
          img.src = e.target.result;

          const newItem = { type: 'image', value: e.target.result, imageObj: img, loaded: false };
          items.push(newItem);

          // 画像ロード完了
          img.onload = () => {
            newItem.loaded = true;
            renderWheel();
          };
          renderItemList();
          saveDataToStorage();
        };
        reader.readAsDataURL(file);
        imageInput.value = ''; // ファイル入力をリセット
      }
    });

    // --- 項目一覧の再描画 ---
    function renderItemList() {
      itemListElem.innerHTML = '';
      items.forEach((item, index) => {
        const li = document.createElement('li');
        li.className = 'item-row';

        if (item.type === 'text') {
          li.textContent = item.value;
        } else {
          const img = document.createElement('img');
          img.src = item.value;
          li.appendChild(img);
        }

        // 削除ボタン
        const delBtn = document.createElement('button');
        delBtn.textContent = '削除';
        delBtn.onclick = () => {
          items.splice(index, 1);
          renderItemList();
          renderWheel();
          saveDataToStorage();
        };
        li.appendChild(delBtn);
        itemListElem.appendChild(li);
      });
    }

    // --- 当選履歴の再描画 ---
    function renderHistory() {
      historyListElem.innerHTML = '';
      historyData.forEach((h) => {
        const li = document.createElement('li');
        const timeSpan = document.createElement('span');
        timeSpan.textContent = `[${h.time}] `;

        if (h.type === 'text') {
          li.textContent = h.value;
          li.prepend(timeSpan);
        } else {
          // 画像の場合
          const img = document.createElement('img');
          img.src = h.value;
          li.appendChild(img);
          li.prepend(timeSpan);
        }
        historyListElem.appendChild(li);
      });
    }

    // --- デバッグモードの切り替え ---
    debugToggle.addEventListener('change', () => {
      debugMode = debugToggle.checked;
      saveDataToStorage();
      updateDebugInfo();
    });

    function updateDebugInfo() {
      if (!debugMode) {
        debugInfoElem.style.display = 'none';
        debugInfoElem.textContent = '';
        return;
      }
      debugInfoElem.style.display = 'block';
      debugInfoElem.textContent = `items: ${JSON.stringify(items, null, 2)}\n`
                                + `historyData: ${JSON.stringify(historyData, null, 2)}\n`
                                + `currentAngle: ${currentAngle.toFixed(2)}\n`;
    }
  </script>
</body>
</html>
